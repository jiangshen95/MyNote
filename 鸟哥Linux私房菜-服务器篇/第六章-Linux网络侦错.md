# 无法联机原因分析
## 硬件问题：网络线材、网络设备、网络布线等
1. 网络线材的问题：  
   网络线分成并行线与跳线 (RJ-45接头)，而并不是所有的设备都支持自动分辨跳线与并行线的功能。所以，必须要了解到你的设备 (Hub/Switch/调制解调器) 所支持的网络线；另外，如果你的网络线有经过门缝处或者是容易凹折处， 那很有可能由于经常性的凹折导致电子讯号不良，所以你需要注意一下这些事情：
     * 网络线被截断；
     * 网络线过度扭曲变形造成讯号不良；
     * 自制网络接头 (如 RJ-45 跳线头) 品质不良；
     * 网络接头与设备 (如 Hub) 接触不良；
2. 网络卡、Hub 及 Router 等网络设备的问题：
     * 网络卡不稳定、质量不佳，或者与整体系统的兼容度不佳 (网络卡也是会坏的)；
     * 各网络设备的接头不佳，接触不良，造成讯号衰减 (经常的拔插就有可能发生)；
     * 由于网络设备所在环境恶劣 (例如过热) 导致的当机问题 (如 switch 热当的问题)；
     * 各网络设备使用方法不良，造成设备功能衰减 (switch 常常插电/断电容易坏)；
3. 设备配置的规则：  
   在各个设备的配置上是有一定的规则的，而最容易发生的问题就是太长的网络线会造成讯号的衰减， 导致网络联机的时间太长甚至无法联机。我们曾在网络基础当中谈过以太网络最长的支持距离 (10BASE5 最长可达 500m)：
     * 使用错误的网络线，最常发生在并行线与跳线的分别 (现在比较少见这个问题了)
     * 架设的网络线过长，导致讯号衰减太严重。例如以太网络 CAT5e 的线理论限制长度大概是在 90 公尺左右 (虽然 10BASE5 可达 500m)，若两个设备 (Hub/主机之间) 长度大于 90 公尺时，自然就容易出现讯号发生问题了！
     * 其他噪声的干扰，最常发生在网络线或者网络设备旁边有太强的磁波；
     * 局域网络上面，节点或者其他的设备太多，过去我们常以所谓的 543 原则来说明：
       * 5 个网段 (segment)。所谓 segment 就在物理连接上最接近的一组计算机，在一个 BNC 网段里面最多只能接 30 台计算机﹐且网线总长不能超过 185m。
       * 4 个增益器 (repeater)。也就是将信号放大的装置。
       * 3 个计算机群体 (population)。这个不好理解﹐也就是说前面所说的 5 个 segment 之中， 只能有 3 个可以装计算机，其它两个不行。
## 软件问题：IP 参数设定、路由设定、服务与防火墙设定等
1. 网络卡的 IP/netmask 设定错误：  
   例如：同一个 IP 在同一个网段中出现造成 IP 冲突、子网掩码设定错误、网络卡的驱动程序使用错误、网络卡的 IRQ、 I/O Address 的设定冲突等等；
2. 路由的问题 (route table)：
3. 通讯协议不相符：
4. 网络负荷的问题 (loading)：
5. 其他问题：  
   例如：一些 port 被防火墙挡住了，造成无法执行某些网络资源；应用程序本身的 Bug 问题；应用程序中用户的网络设定错误；以及不同的操作系统的兼容性问题等等。
## 问题的处理
* 先由自身的环境侦测起，可以由自身 PC 上的网络卡查起，到网络线、到 Hub 再到调制解调器等等的硬件先检查完。 在这个步骤当中，最好用的软件就是 ping ，而你最好能有两部以上的主机来进行联机的测试；
* 确定硬件没问题了，再来思考软件的设定问题！

如果网络不通时，可以依序这样处理：
1. 了解问题：这个问题是刚刚发生？还是因为之前我做了什么动作而导致无法联机？
2. 确认 IP：先看看自己的网卡有无驱动？能否取得正确的 IP 相关参数来联机？
3. 确认区网联机：利用 ping 来沟通两部主机 (路由器或 IP 分享器)，确定网络线与中继的 hub/switch 工作正常；
4. 确认对外联机：看主机或 IP 分享器能否依据第四章的方法顺利取得 IP 参数，并以 ping 的方法确定对外联机是可以成功的 (例如 ping 168.95.1.1)；
5. 确认 DNS 查询：利用 nslookup 或 host 或 dig 检查 www.google.com 看看；
6. 确认 Internet 节点：可以利用 traceroute 检查各节点是否没问题？
7. 确认对方服务器正常服务：是否对方服务器忙线中？或他的机器挂了？
8. 确认我方服务器：如果是别人连不上我这部主机，那检查主机某些服务正确启动否？可利用 netstat 检查。或是否某些安全机制的软件没有设定好，例如 SELinux 这项机制；
9. 防火墙或权限的问题：是否由于权限设定错误所致？ 是否由于你的机器有防火墙忘记启用可联机的埠口所致？这个可以透过 tcpdump 来处理！

# 处理流程
## 步骤一：网卡工作确认
1. 确定网络卡已经驱动成功：  
   可以利用 lspci 以及 dmesg 这两个命令查询相关的设备与模块的对应。
2. 确定可以手动直接建立 IP 参数：  
   利用 ifconfig 或 ip 来直接给予该网络卡一个网络地址试试。
   ```
   [root@www ~]# ifconfig eth0 192.168.1.100
   ```
   如果可以建立起该 IP ，就以 ping 来检测看看。
## 步骤二：局域网络内各项连接设备检测
1. 关于网域的概念：
2. 关于 Gateway 与 DNS 的设定：
3. 关于 Windows 端的工作组与计算机名称：  
   假如你还需要资源共享，那么你就必须在 windows 系统中开放档案分享， 并且建议所有的计算机将『工作组』设定相同，但『计算机名称』则不能相同。这个只与网芳及 SAMBA 服务器有关。

如果无法 ping 成功：
1. IP 参数是否设定正确：
2. 联机的线材问题：
3. 网卡或 Hub/Switch 本身出问题：
## 步骤三：取得正确的 IP 参数
最常发现无法顺利取得 IP 的错误就是『BOOTPROTO』这个设定值设定错了，因为 static 与 dhcp 协议所产生的 IP 要求是不一样的。
## 步骤四：确认路由表的规则
可以尝试使用 ping 来连连看 Hinet 的 DNS 主机，也就是 168.95.1.1 那部机器。\
```
[root@www ~]# ping -c 3 168.95.1.1
```
## 步骤五：主机名与 IP 查询的 DNS 错误
```
[root@www ~]# vim /etc/resolv.conf
nameserver 168.95.1.1
nameserver 139.175.10.20
```
另外，每一部主机都会有主机名 (hostname) ，预设的主机名会是 localhost ，这个主机名会有一个 127.0.0.1 的 IP 对应在 /etc/hosts 当中。如果你曾经修改过你的主机名，该主机名却无法有一个正确 IP 的对应， 那么你的主机在开机时，可能会有好几十分钟的延迟。 所以，/etc/hosts 与你的主机名对应，对于内部私有网域来说，是相当重要的设定项目。
## 步骤六：Linux 的 NAT 服务器或 IP 分享器出问题
NAT 主机一定是部路由器，所以你必须要在 Linux 上面观察好正确的路由信息。另外， NAT 主机上面的防火墙设定是否合理？ IP 分享器上面是否有设定抵挡的机制等等，都会影响到对外联机是否能够成功的问题点。
## 步骤七：Internet 的问题
使用 traceroute 查看问题来自那个地方。
## 步骤八：服务器的问题
* 服务器并没有开放该项服务：
* 主机的权限设定错误：例如你将某个目录设定为 drwx------ ，该目录拥有者为 root ， 你却将该目录开放给 WWW 来浏览，由于 WWW 无法进入该目录，所以就无法正确的给客户端浏览。这是最典型的权限设定错误的情况。
* 安全机制设定错误：例如 SELinux 是用来更细微控管主机存取的一种核心机制，结果你启动的是系统原先不支持的类型， 那么 SELinux 反而可能会抵挡该服务的提供！而其他例如 /etc/hosts.deny, PAM 模块等等， 都可能造成使用者无法登入的问题！这就不是网络问题，而是主机造成联机无法成功！
* 防火墙问题：防火墙设定错误也是一个很常见的问题，你可以使用 tcpdump 来追踪封包的流向， 以顺利的了解防火墙是否设定错误。